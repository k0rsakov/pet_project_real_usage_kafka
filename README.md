# –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Kafka

## –û–ø–∏—Å–∞–Ω–∏–µ YouTube

üî• –í —ç—Ç–æ–º [–≤–∏–¥–µ–æ](https://youtu.be/R2yGsEfPKS4) —Ç—ã —É–∑–Ω–∞–µ—à—å –≤—Å—ë, —á—Ç–æ –¥–æ–ª–∂–µ–Ω –∑–Ω–∞—Ç—å –¥–∞—Ç–∞-–∏–Ω–∂–µ–Ω–µ—Ä –æ Apache Kafka.
–ü–æ–∫–∞–∑—ã–≤–∞—é —Ä–µ–∞–ª—å–Ω—ã–π –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –∫–µ–π—Å: –∫–∞–∫ —Å–æ–±–∏—Ä–∞—Ç—å, —Ö—Ä–∞–Ω–∏—Ç—å –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏–π (clickstream) —Å –ø–æ–º–æ—â—å—é
Kafka, Python, S3 (MinIO) –∏ ClickHouse.

–°—Å—ã–ª–∫–∏:
–ú–µ–Ω—Ç–æ—Ä—Å—Ç–≤–æ/–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –ø–æ IT ‚Äì https://korsak0v.notion.site/Data-Engineer-185c62fdf79345eb9da9928356884ea0
TG –∫–∞–Ω–∞–ª ‚Äì https://t.me/DataLikeQWERTY
Instagram ‚Äì https://www.instagram.com/i__korsakov/
Habr ‚Äì https://habr.com/ru/users/k0rsakov/publications/articles/
GitHub –ø—Ä–æ–µ–∫—Ç–∞ ‚Äì https://github.com/k0rsakov/pet_project_real_usage_kafka
–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è data engineer Kafka ‚Äì https://habr.com/ru/articles/836302/

üîª –ß—Ç–æ —Ç–µ–±—è –∂–¥–µ—Ç:

- –ß—Ç–æ —Ç–∞–∫–æ–µ Kafka, –∑–∞—á–µ–º –æ–Ω–∞ –Ω—É–∂–Ω–∞ –∏ –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏–Ω—Ü–∏–ø WORM (Write Once Read Many)
- –ö–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏—è, —Ç–æ–ø–∏–∫–∏ –∏ –≥—Ä—É–ø–ø—ã –≤ Kafka (–Ω–∞ –∂–∏–≤—ã—Ö –ø—Ä–∏–º–µ—Ä–∞—Ö)
- –ö–∞–∫ –ø–∏—Å–∞—Ç—å –∏ —á–∏—Ç–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Kafka —á–µ—Ä–µ–∑ Python –∏ CLI
- –ö–∞–∫ —Å–æ–±–∏—Ä–∞—Ç—å clickstream –¥–ª—è –º—É–∑—ã–∫–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
- –ö–∞–∫ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ Kafka –≤ S3 (Minio) –≤ —Ñ–æ—Ä–º–∞—Ç–µ Parquet
- –ö–∞–∫ —á–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ Kafka –∏ S3 –≤ ClickHouse
- –°–æ–≤–µ—Ç—ã –∏ –ª—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ –¥–ª—è –¥–∞—Ç–∞-–∏–Ω–∂–µ–Ω–µ—Ä–æ–≤ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å Kafka
- –¢–æ–ø–æ–≤—ã–µ –æ—à–∏–±–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–≤–µ—Ä—à–∞—é—Ç –Ω–æ–≤–∏—á–∫–∏ (–∏ –∫–∞–∫ –∏—Ö –∏–∑–±–µ–∂–∞—Ç—å)
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤: Spark, Kafka Connect, NiFi –∏ –¥—Ä.
- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –≤—ã–±–æ—Ä—É —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—é

üí° –í –∫–æ–Ω—Ü–µ —Ä–æ–ª–∏–∫–∞ ‚Äî —Å–æ–≤–µ—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ —Å—ç–∫–æ–Ω–æ–º—è—Ç —Ç–µ–±–µ –∫—É—á—É –≤—Ä–µ–º–µ–Ω–∏ –∏ –Ω–µ—Ä–≤–æ–≤!

–¢–∞–π–º–∫–æ–¥—ã:

- 00:00 ‚Äì –ù–∞—á–∞–ª–æ
- 01:04 ‚Äì –ß—Ç–æ —Ç–∞–∫–æ–µ Kafka (–ö–∞—Ñ–∫–∞)
- 03:06 ‚Äì –°–≤–æ–π—Å—Ç–≤–∞ –∏ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞ Kafka (–ö–∞—Ñ–∫–∏)
- 03:45 ‚Äì –ß—Ç–æ —Ç–∞–∫–æ–µ Producer (–ü—Ä–æ–¥—é—Å–µ—Ä)
- 04:05 ‚Äì –ß—Ç–æ —Ç–∞–∫–æ–µ Consumer (–ö–æ–Ω—Å—É–º–µ—Ä)
- 05:10 ‚Äì –†–∞–∑–±–æ—Ä –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞
- 06:35 ‚Äì –ó–∞–ø—É—Å–∫ –∫–æ–¥–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏ –≤ Kafka (–ö–∞—Ñ–∫—É)
- 07:56 ‚Äì –ò–∑—É—á–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ Kafka UI (–ö–∞—Ñ–∫–∏)
- 09:24 ‚Äì –ß—Ç–µ–Ω–∏–µ Kafka (–ö–∞—Ñ–∫–∏) —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥–Ω—É—é —Å—Ç—Ä–æ–∫—É (CLI)
- 12:22 ‚Äì –ß—Ç–µ–Ω–∏–µ Kafka (–ö–∞—Ñ–∫–∏) —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥–Ω—É—é —Å—Ç—Ä–æ–∫—É (CLI) –ø—Ä–∏ —É–∫–∞–∑–∞–Ω–∏–∏ –≥—Ä—É–ø–ø—ã –∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —á—Ç–æ —Ç–∞–∫–æ–µ –≥—Ä—É–ø–ø–∞
- 15:45 ‚Äì –ß–µ–º –º–æ–∂–Ω–æ —á–∏—Ç–∞—Ç—å Kafka (–ö–∞—Ñ–∫—É)
- 16:45 ‚Äì –†–∞–∑–±–æ—Ä —Ç–∏–ø–æ–≤–æ–π –∑–∞–¥–∞—á–∏ –¥–∞—Ç–∞-–∏–Ω–∂–µ–Ω–µ—Ä–∞, —Å–≤—è–∑–∞–Ω–Ω–æ–π —Å Kafka (–ö–∞—Ñ–∫–æ–π)
- 17:55 ‚Äì –†–∞–∑–±–æ—Ä ClickStream (–∫–ª–∏–∫—Å—Ç—Ä–∏–º–∞)
- 20:25 ‚Äì –ü—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –∑–∞–ø–∏—Å–∏ –≤ Kafka (–ö–∞—Ñ–∫—É)
- 22:52 ‚Äì –ó–∞–ø—É—Å–∫ ClickStream
- 24:40 ‚Äì –ü—Ä–æ—Å—Ç–æ–µ —á—Ç–µ–Ω–∏–µ Kafka (–ö–∞—Ñ–∫–∏) —á–µ—Ä–µ–∑ Python (–ø–∏—Ç–æ–Ω)
- 25:28 ‚Äì –ó–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö –∏–∑ Kafka (–ö–∞—Ñ–∫–∏) –≤ s3 —á–µ—Ä–µ–∑ Python (–ø–∏—Ç–æ–Ω)
- 29:36 ‚Äì –ß—Ç–µ–Ω–∏–µ Kafka (–ö–∞—Ñ–∫–∏) –∏ –∑–∞–ø–∏—Å—å –≤ ClickHouse (–∫–ª–∏–∫—Ö–∞—É—Å) —á–µ—Ä–µ–∑ ClickHouse (–∫–ª–∏–∫—Ö–∞—É—Å)
- 35:00 ‚Äì –†–∞–∑–±–æ—Ä –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ Python (–ø–∏—Ç–æ–Ω–µ) –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Kafka (–ö–∞—Ñ–∫–æ–π)
- 36:42 ‚Äì –†–∞–∑–±–æ—Ä –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ ClickHouse (–∫–ª–∏–∫—Ö–∞—É—Å) –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Kafka (–ö–∞—Ñ–∫–æ–π)
- 37:27 ‚Äì –ú–æ–¥–µ–ª–∏ ClickHouse (–∫–ª–∏–∫—Ö–∞—É—Å–∞) –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Kafka (–ö–∞—Ñ–∫–æ–π)
- 37:38 ‚Äì –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞

### –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
python3.12 -m venv venv && \
source venv/bin/activate && \
pip install --upgrade pip && \
pip install poetry && \
poetry lock && \
poetry install
```

#### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –≤ –æ–∫—Ä—É–∂–µ–Ω–∏–µ

```bash
poetry lock && \
poetry install
```

### –ü–æ–¥–Ω—è—Ç–∏–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã

```bash
docker compose up -d
```

### –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Minio

–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ:

- `login`: `minioadmin`
- `password`: `minioadmin`

## Kafka

–ü–µ—Ä–µ–¥ –¥–∞–ª—å–Ω–µ–π—à–∏–º —á—Ç–µ–Ω–∏–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥—É—é —Å–≤–æ—é —Å—Ç–∞—Ç—å—é ‚Äì
[–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è data engineer Kafka](https://habr.com/ru/articles/836302/).

Kafka ‚Äì —ç—Ç–æ –±—Ä–æ–∫–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–π –∏–º–µ–µ—Ç –ø—Ä–∏–Ω—Ü–∏–ø "*Write once read many (WORM)*".

Kafka –≤–µ—Ä—Ö–Ω–µ—É—Ä–æ–≤–Ω–µ–≤–æ:

```mermaid
flowchart LR
    A["Producer<br>(–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å)"] -- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è --> B((Kafka<br>Topic))
    B -- –°–æ–æ–±—â–µ–Ω–∏—è –ø–æ—Å—Ç—É–ø–∞—é—Ç --> C["Consumer 1<br>(–ü–æ–ª—É—á–∞—Ç–µ–ª—å 1)"]
    B -- –°–æ–æ–±—â–µ–Ω–∏—è –ø–æ—Å—Ç—É–ø–∞—é—Ç --> D["Consumer 2<br>(–ü–æ–ª—É—á–∞—Ç–µ–ª—å 2)"]
    B -- –°–æ–æ–±—â–µ–Ω–∏—è –ø–æ—Å—Ç—É–ø–∞—é—Ç --> F["Consumer N<br>(–ü–æ–ª—É—á–∞—Ç–µ–ª—å N)"]

    style A fill:#f9f,stroke:#333,stroke-width:1px
    style B fill:#bbf,stroke:#333,stroke-width:2px
    style C fill:#afa,stroke:#333,stroke-width:1px
    style D fill:#afa,stroke:#333,stroke-width:1px
    style F fill:#aff,stroke:#333,stroke-width:1px
```

### –ü—Ä–æ—Å—Ç–æ–π `producer`

–ó–∞–ø—É—Å–∫–∞–µ–º [simple_producer.py](code/simple_producer.py)

#### –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–æ–æ–±—â–µ–Ω–∏–π

–ï—Å—Ç—å –¥–≤–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞:

- –í [Kafka UI](http://localhost:8080/)
- –ß–µ—Ä–µ–∑ Kafka CLI

–ü—Ä–æ—Å–º–æ—Ç—Ä —Å–æ–æ–±—â–µ–Ω–∏–π "_–ë–µ–∑ –≥—Ä—É–ø–ø—ã_":

```bash
docker exec -it kafka kafka-console-consumer \
  --bootstrap-server localhost:9092 \
  --topic my_topic \
  --from-beginning
```

–ü—Ä–æ—Å–º–æ—Ç—Ä —Å–æ–æ–±—â–µ–Ω–∏–π "_–¢–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ_":

```bash
docker exec -it kafka kafka-console-consumer \
  --bootstrap-server localhost:9092 \
  --topic my_topic
```

–ü—Ä–æ—Å–º–æ—Ç—Ä —Å–æ–æ–±—â–µ–Ω–∏–π "_–ù–æ–≤—ã–µ –Ω–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ_":

```bash
docker exec -it kafka kafka-console-consumer \
  --bootstrap-server localhost:9092 \
  --topic my_topic \
  --group mygroupcli
```

–ü—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ —Ñ–∏–∫—Å–∏—Ä—É—é—Ç—Å—è –≤ Kafka –∏ –º—ã –º–æ–∂–µ–º —ç—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–º–∞–Ω–¥–æ–π:

```bash
docker exec -it kafka kafka-consumer-groups \
  --bootstrap-server localhost:9092 \
  --group mygroupcli \
  --describe 
```

## Clickstream

–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ [simple_clickstream.py](code/simple_clickstream.py) —ç–º—É–ª–∏—Ä—É–µ—Ç—Å—è –∫–ª–∏–∫—Å—Ç—Ä–∏–º –º—É–∑—ã–∫–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞.

–í Kafka topic –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Å–æ–±—ã—Ç–∏—è:

| id | name_en                  | name_ru               |
|----|--------------------------|-----------------------|
| 1  | track_playback           | –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —Ç—Ä–µ–∫–∞ |
| 2  | pause_track              | –ü–∞—É–∑–∞ —Ç—Ä–µ–∫–∞           |
| 3  | resume_track             | –í–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç—Ä–µ–∫–∞   |
| 4  | skipping_track_next      | –ü–µ—Ä–µ–ª–∏—Å—Ç—ã–≤–∞–Ω–∏–µ –≤–ø–µ—Ä—ë–¥ |
| 5  | skipping_track_prev      | –ü–µ—Ä–µ–ª–∏—Å—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞–∑–∞–¥  |
| 6  | adding_track_to_playlist | –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –ø–ª–µ–π–ª–∏—Å—Ç |
| 7  | track_like               | –õ–∞–π–∫ —Ç—Ä–µ–∫–∞            |
| 8  | track_unlike             | –°–Ω—è—Ç–∏–µ –ª–∞–π–∫–∞ —Å —Ç—Ä–µ–∫–∞  |

–° –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–º "_–≤–µ—Å–æ–º_" –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è —Ç–æ –∏–ª–∏ –∏–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ. –í—ã –º–æ–∂–µ—Ç–µ —ç—Ç–æ —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞—Ç—å —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ –≤ —Ñ—É–Ω–∫—Ü–∏–∏
`generate_realistic_event` –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π `event_weights`.

–î–∞–ª–µ–µ –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –æ–¥–∏–Ω –∏–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–π –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –≤ `generate_users_df` –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —É–∂–µ –≤ Kafka topic
`music_events`.

## –ó–∞–¥–∞—á–∞ –¥–∞—Ç–∞-–∏–Ω–∂–µ–Ω–µ—Ä–∞

–°–æ–±–∏—Ä–∞—Ç—å —Å–æ–±—ã—Ç–∏—è –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –ø–æ —Å–µ—Ä–≤–∏—Å—É.

### –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–æ–æ–±—â–µ–Ω–∏–π

–ó–∞–ø—É—Å–∫–∞–µ–º [simple_consumer.py](code/simple_consumer.py). –ù–æ –Ω–∞–º —ç—Ç–æ—Ç –≤–∞—Ä–∏–∞–Ω—Ç –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã, –ø–æ—Ç–æ–º—É —á—Ç–æ –æ–Ω
—Ç–æ–ª—å–∫–æ —á–∏—Ç–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è, –Ω–æ –Ω–µ —Å–æ–±–∏—Ä–∞–µ—Ç –∏—Ö.

### –°–±–æ—Ä `events`

–†–∞—Å—Å–º–æ—Ç—Ä–∏–º –¥–≤–∞ —Å–ø–æ—Å–æ–±–∞ —Å–±–æ—Ä–∞ `events`:

- –ß–µ—Ä–µ–∑ Python + MinIO
- –ß–µ—Ä–µ–∑ ClickHouse

#### Python + MinIO

–ó–∞–ø—É—Å–∫–∞–µ–º [kafka_to_minio_parquet_on_python.py](code/kafka_to_minio_parquet_on_python.py). –õ–æ–≥–∏–∫–∞ –ø—Ä–æ—Å—Ç–∞—è: –º—ã —á–∏—Ç–∞–µ–º
—Ç–æ–ø–∏–∫ `music_events` –∂–¥—ë–º "_–æ—Ç—Å–µ—á–∫–∏_" –ø–æ `BATCH_SIZE` –∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ `.parquet` –≤ –Ω—É–∂–Ω–æ –ø–∞—Ä—Ç–∏—Ü–∏—é.

Kafka + Python + MinIO –≤–µ—Ä—Ö–Ω–µ—É—Ä–æ–≤–Ω–µ–≤–æ:

```mermaid
flowchart TB
    AA["Producer<br>(–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å)"] -- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è --> A((Kafka<br>Topic))
    A(("Kafka<br>Topic")) -- poll messages --> B["Python Consumer<br>(kafka_to_minio_parquet_on_python.py)"]
    B -- batch (.json -> pd.DataFrame) --> C["Pandas DataFrame"]
    C -- Save as .parquet --> D["MinIO<br>(S3 —Å–æ–≤–º–µ—Å—Ç–∏–º–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ)"]

    style AA fill:#f9f,stroke:#333,stroke-width:1px
    style A fill:#bbf,stroke:#333,stroke-width:2px
    style B fill:#ffe599,stroke:#333,stroke-width:2px
    style C fill:#b6d7a8,stroke:#333,stroke-width:2px
    style D fill:#76a5af,stroke:#333,stroke-width:2px
```

##### Data quality

–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –¥–∞–Ω–Ω—ã—Ö, –∑–∞–ø–∏—Å–∞–Ω–Ω—ã—Ö –≤ MinIO –º–æ–∂–Ω–æ –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è
[check_count_partition_prod_python.py](code/check_count_partition_prod_python.py).

–î–∞–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –ø–æ–∫–∞–∂–µ—Ç:

1) –¢–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –≤ `bucket`
2) –¢–µ–∫—É—â–∞—è "_–ø–ª–æ—Å–∫–∞—è_" –º–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö –≤ `bucket`
3) –ü–µ—Ä–≤—ã–µ –¥–µ—Å—è—Ç—å (10) —Å—Ç—Ä–æ–∫ —Å–æ–±—ã—Ç–∏—è `track_playback` (`1`)

#### ClickHouse

–ü–µ—Ä–µ–¥ –¥–∞–ª—å–Ω–µ–π—à–∏–º —á—Ç–µ–Ω–∏–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥—É—é —Å–≤–æ–∏ —Å—Ç–∞—Ç—å–∏:

- [–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è Data-Engineer ClickHouse](https://habr.com/ru/articles/842818/)
- [CDC –Ω–∞ –ø—Ä–∏–º–∏—Ç–∏–≤–∞—Ö](https://habr.com/ru/articles/812797/)

Kafka + ClickHouse –≤–µ—Ä—Ö–Ω–µ—É—Ä–æ–≤–Ω–µ–≤–æ:

```mermaid
flowchart TB
    A["Producer<br>(–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å)"] -- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è --> B((Kafka<br>Topic))
    B -- –°–æ–æ–±—â–µ–Ω–∏—è –ø–æ—Å—Ç—É–ø–∞—é—Ç --> C["–¢–∞–±–ª–∏—Ü–∞ —Å –¥–≤–∏–∂–∫–æ–º Kafka<br>(consumer, –ª–æ–≥–∏—á–µ—Å–∫–∏–π)"]
    C -- SELECT * FROM (Kafka) --> D["–ú–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ<br>–ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ"]
    D -- INSERT INTO --> E["–§–∏–∑–∏—á–µ—Å–∫–∞—è —Ç–∞–±–ª–∏—Ü–∞<br>(—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö)"]

    style A fill:#f9f,stroke:#333,stroke-width:1px
    style B fill:#bbf,stroke:#333,stroke-width:2px
    style C fill:#ffe599,stroke:#333,stroke-width:2px
    style D fill:#b6d7a8,stroke:#333,stroke-width:2px
    style E fill:#76a5af,stroke:#333,stroke-width:2px
```

–°–æ–∑–¥–∞—ë–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏ –¥–ª—è —á—Ç–µ–Ω–∏—è Kafka.

> –ù–∏–∂–µ –¥–≤–µ –º–æ–¥–µ–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–º–æ–≥—É—Ç –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ç–æ–ø–∏–∫–∏: `music_events`, `my_topic` –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.

```sql
DROP TABLE IF EXISTS kafka_simple_event_consumer;
DROP TABLE IF EXISTS kafka_simple_event_phys_table;
DROP TABLE IF EXISTS kafka_simple_event_mat_view;

CREATE TABLE kafka_simple_event_consumer
(
    uuid String,
    first_name String,
    last_name String,
    middle_name String,
    timestamp String
) ENGINE = Kafka SETTINGS
    kafka_broker_list = 'kafka',
    kafka_topic_list = 'my_topic',
    kafka_group_name = 'foo',
    kafka_format = 'JSON';
    
CREATE TABLE kafka_simple_event_phys_table
(
    uuid String,
    first_name String,
    last_name String,
    middle_name String,
    timestamp String
)
ENGINE = MergeTree()
ORDER BY (uuid);

CREATE MATERIALIZED VIEW kafka_simple_event_mat_view TO kafka_simple_event_phys_table 
    AS SELECT * FROM kafka_simple_event_consumer;

DROP TABLE IF EXISTS kafka_music_event_consumer;
DROP TABLE IF EXISTS kafka_music_event_phys_table;
DROP TABLE IF EXISTS kafka_music_event_mat_view;

CREATE TABLE kafka_music_event_consumer
(
    event_params String,
    event_timestamp_ms String
) ENGINE = Kafka SETTINGS
    kafka_broker_list = 'kafka',
    kafka_topic_list = 'music_events',
    kafka_group_name = 'foo',
    kafka_format = 'JSON';
    
CREATE TABLE kafka_music_event_phys_table
(
    event_params String,
    event_timestamp_ms String,
    uuid UUID DEFAULT generateUUIDv4() 
)
ENGINE = MergeTree()
ORDER BY (uuid);

CREATE MATERIALIZED VIEW kafka_music_event_mat_view TO kafka_music_event_phys_table 
    AS SELECT * FROM kafka_music_event_consumer;
```

–ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ç–æ–ø–∏–∫–∞ `my_topic` –≤ ClickHouse:

```sql
SELECT * FROM kafka_simple_event_mat_view;
```

–ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ç–æ–ø–∏–∫–∞ `music_events` –≤ ClickHouse:

```sql
SELECT * FROM kafka_music_event_mat_view;

SELECT * 
FROM kafka_music_event_mat_view
WHERE 1=1
AND JSONExtractInt(event_params, 'event_type_id') = 1;
```

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1) –ù–µ –∑–∞–±—ã–≤–∞–π—Ç–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –≥—Ä—É–ø–ø—É –¥–ª—è —á—Ç–µ–Ω–∏—è, —á—Ç–æ–±—ã —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å `offset`
2) –ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —á–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –≤–∏–¥–µ `.json`, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∂–∏–≤–∞—Ç—å –∑–∞ –º–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –µ—ë.
3) –î–ª—è —á—Ç–µ–Ω–∏—è Kafka –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏ –¥—Ä—É–≥–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã: Spark, Kafka Connect, NiFi –∏ –¥—Ä—É–≥–∏–µ. –Ø –ø–æ–∫–∞–∑–∞–ª –ø—Ä–æ—Å—Ç–æ
   –ø—Ä–∏–º–µ—Ä—ã —Ç–æ–≥–æ –∫–∞–∫ –º–æ–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Å —Ç–æ–ø–∏–∫–∞–º–∏. –í—ã –≤—ã–±–∏—Ä–∞–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç "*–ø–æ —Å–µ–±–µ*"
4) –ü—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–∏–µ —Ñ–æ—Ä–º–∞—Ç—ã –∑–∞–ø–∏—Å–∏: `.avro`, Protobuf, String, Binary, etc
5) –ù–µ –∑–∞–±—ã–≤–∞–π—Ç–µ –ø—Ä–æ –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Kafka –∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
    1) –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Kafka –ø–æ–º–æ–≥–∞–µ—Ç –±—ã—Å—Ç—Ä–µ–µ —á–∏—Ç–∞—Ç—å –∏ –ø–∏—Å–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑/–≤ —Ç–æ–ø–∏–∫
    2) –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –ë–î/S3 –ø–æ–º–æ–≥–∞–µ—Ç –±—ã—Å—Ç—Ä–µ–µ —á–∏—Ç–∞—Ç—å –∏ –ø–∏—Å–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –ø–∞—Ä—Ç–∏—Ü–∏–∏
6) –†–µ–∫–æ–º–µ–Ω–¥—É—é –∫–Ω–∏–≥—É –ø–æ
   Kafka ‚Äì [Apache Kafka. –ü–æ—Ç–æ–∫–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏ –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö, 2-–µ –∏–∑–¥–∞–Ω–∏–µ](https://www.piter.com/collection/bazy-dannyh/product/apache-kafka-potokovaya-obrabotka-i-analiz-dannyh-2-e-izdanie).
   –¢–∞–º –º–Ω–æ–≥–æ –æ—Å–Ω–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ —Å–∏—Ö –ø–æ—Ä –Ω–µ —É—Å—Ç–∞—Ä–µ–ª–∏.
